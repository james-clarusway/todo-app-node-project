pipeline {
    agent { label "master" }
    environment {
        ECR_REGISTRY = "846133131154.dkr.ecr.us-east-1.amazonaws.com"
        APP_REPO_NAME= "clarusway-repo/todo-app"
    }
    stages {
        stage('Build Docker Image') {
            steps {
                sh 'docker build --force-rm -t "$ECR_REGISTRY/$APP_REPO_NAME:latest" .'
                sh 'docker image ls'
            }
        }
        stage('Push Image to ECR Repo') {
            steps {
                sh 'aws ecr get-login --region eu-central-1 | docker login -u AWS -p eyJwYXlsb2FkIjoiems0TUo0cTFWbmhwdlJEcFFlUU9CWE1WelVuV0t0V3Eva3FiekZtWGxYa2FMNjZwV2xGcDJ2S213VkFYUCtwNnZ2bFhHSHZWYlpOMnM3WFJvWStaVi9SQkt2N09MdUZ1SWRXbk11aHEzTk41TFFMd1ZGSGx5RUt6bHZENlN6WUdVZHM1aTQ0L2o5WEZhWFpuVytVUEVZbGVpZ2ZuSHpWRjZvcldHN2ZxRjBKM3V0RC9Jck9GckIxNmVsTDhUTzlqalBtaU5TWE92a0VkZ2JTSDVGQUw3MmRSQzFDRG14Z29GeEp0d0tsaytGaFJuakFVODdOUk1vc2t0a21OTW45QzF1R2JKWENuaUorb01xMW81eHdUYmFRbm8zK21PdXNWNmlYSEQ4cVQyZlY2aUc3b1hKS0Y0VnQxai9KRUJLWFRXNFpGRkhzeTNHYWlERUtsMnBoazRlZGxtL3kxUUhCSXE2UHg1eXVMOUJreFU5eHVINkdBYlM1ckEzOXZkd01lREYvcWJUcmtmVy9vaDJ1V2phcmJXTzVXM3YwMUMzNWVRSUVseFFSUVJJYVFoZXNHSlBzOEdDYVlTNVQ2ay9MOWJkd0svRVBDb29McHFVV1ZJWFhDeTkwT3Z4dFp2WkJNWkhkUzVpeHVIOVBKci9CU2lsYmNuZ2VENEIzVWJ4Y0JoVzk5Yi83a2hpRXRvaFVNUnFZa0lZdE10dmxYeTJOamtCMGh1Y2FHRkNiOE5hSzgweHN6R3IwejJBRUZtdlBkT0FwanBnQ29IUkZpUjh1YThHblFFQi95cFJ4M2xoRWZsNnZKa3RReEhtazRpSU5MNEpnQU5mV1lPMWM2R21DOXJhSFVsMXNvamdPblhMOUdiVHR6UjBQYi94VFZvbG9BdW1GZjZTUGhmZlUxWmttME8xSElPdzVQSzBWTDdOVDliNEJHNVltK0dJV1JDRmhWNEp4aHJIUGRhOTROenovR3d6SjY0ZzhyTnFLeUI3OFRYZW1QTWMxWEpzRnNUTTFiMWpTWmxEYmY4ZU55NkdYZ1VCckdvVzFKUGJ0MHNkbFA3NXZpcG10REVkS2E4dVhFcnRZcW02RjhiWWhDME8zbXJCRVhtb2ZQNUdxNS9Mb0ZnUVdubEw3aStmRTFVYnVnTDduS2JJWC9oTmZkUHlXeVNaekVvMitnWDRTSml3UzZOL2Z4V0VmaUZza1JmbVRDR1YyMTBSajFTRlhTTm9hY2dmSG9ieE9MU2lOVStwK2xia0xpb2VLQjF3QnViTzlkdDErODNaTm51WVZkK2ZHcCtRa2F2UWFKRkdIaHVNNzUvSGc2SVhsK2x2eHJmVFdLNk9FVmFRdzdLOWd5NGlKMndlcnZMNzVUcmF5ZSthMTduN3JDM2tCdmM4d3BKVVhMVlFSZEJGaWQrdFpObnV2Q29Uc3l5bzFGZjVrTGxyaXpZRnpsMVRBeWh3UzlrZWRMWHVrNjJNK2xoZEs3US9jR2QvQmRXNzRVVjgwSUcyVS93cVNIVWsvNkdXUm5kb1dxeEt5WURzYVk1NWJKaUFjenllUnN0VnVrQzhjMTExUDArMEdybVRsZytveTNua0JxTkVzQjJweU03Q2lxWCt0a0ZxQkZRY21INCsrdU1ablU4TE5Ua0RkYmlVOTRyNnRVK1dBa05kU3VGV2twVERxUEkyYVNxcVVMWmpFNGNiSnorVGh1LzNyTEFEblZqTVBuZUtwTzllQnNBRmdXOVNMMWcrRnllSS9pL0VUbERwTytTVXhQeHJ5NW42UDNEcWd0cVpvQ04rZHJxUE1wUmNGbldxcHhnN2NMUU16eHhTb1NiaEhmUGNya3daR0V4K1ROeFhCVlU5Z29ITDVTV3RjZHMyVUNJQ0xmNWQvMk5jZmcvWnBILzNZekZ0cjBZek5yU2tkQzRTaGNSYStIamNtQ25uTXdVUEozTHNGcStkanlZMmFOZk5zMS8wUnlnbEhSd3FldldKb1BTdGxJVXhmYmFjUXlmeGJMMkVRb0NKQ1VGN3F4NkZURnU5LzNlZ2FaOXY3V2VMUkFkYTFzMThPSGJmeXBiM1d6dU1rblE0RXRYL1BaYUpjRUQwcXM1QytlVlF6ams1cDZ2YnFxZDR5eVpWNkcxMnBNYmJBZlNaNTJYOGg3MVNzQm1pKzBvYWlPSUZ4eDFKMUNpWVMrNW9oMlJmV2FMY1g3Y1BuWUtmRlpzeE5sM0JVMWxIZVNRTjdDTmlkYkx4ckl2ZDlIWnhWemdFeS9VRVQ2cDlZbG5LWS9SZTVhdnRuMWdVNFlReFhYM1h4Ung2c2FGa295Yi9lbEZ2OXc2VVZGS0cvMHRuZ3RuUE1EbmlNbTUybG1yZTJad1hjUDBWb3pvOG1CZFc4blBRPT0iLCJkYXRha2V5IjoiQVFFQkFIaDN6WU9kdHBCQlNWdy9ZMmFuOEJYSUQ0a3dMUWZub1RqNXp3WnRHSlpvWlFBQUFINHdmQVlKS29aSWh2Y05BUWNHb0c4d2JRSUJBREJvQmdrcWhraUc5dzBCQndFd0hnWUpZSVpJQVdVREJBRXVNQkVFRElFWWtHUExTVjgxbnBmaDB3SUJFSUE3QzltV2dEdGdqTk1LS3hZRjJyQXFOeHdTcGMybTB4NjI3MXVJZmlwZEpZNVNNN3VOTXpqbThVMXlwR3dzT0dVZW5WMngxSXVKUGp4b2piZz0iLCJ2ZXJzaW9uIjoiMiIsInR5cGUiOiJEQVRBX0tFWSIsImV4cGlyYXRpb24iOjE1OTkzMzQwMzh9 846133131154.dkr.ecr.eu-central-1.amazonaws.com/clarusway-repo/todo-app'
                sh 'docker push "$ECR_REGISTRY/$APP_REPO_NAME:latest"'
            }
        }
    }
    post {
        always {
            echo 'Deleting all local images'
            sh 'docker image prune -af'
        }
    }
}
